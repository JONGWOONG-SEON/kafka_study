# 카프카 설치와 구성하기

## 1. 설치 준비

### 운영체제 선택
- **리눅스 기반 운영체제** 권장: 우분투, CentOS, RHEL 등.
- 안정성과 성능 최적화를 위해 리눅스 환경에서 설치하는 것이 일반적.

### 자바 설치
- **JDK(Java Development Kit)** 8 이상 필요.
- 카프카는 자바 기반 애플리케이션이므로 설치 전 자바 환경이 반드시 구성되어야 함.

### 주키퍼 설치
- **주키퍼(Zookeeper)**:
  - 분산 시스템의 메타데이터 관리 및 코디네이션 서비스 제공.
  - 카프카의 클러스터 구성에서 **리더 선출**과 같은 역할 수행.
- **앙상블(Ensemble)** 구성:
  - 홀수 개의 서버로 구성(3개 또는 5개 권장).
  - 앙상블은 과반수 서버가 가용한 경우 요청 처리 가능.
  - 각 서버는 공통 설정 파일 및 고유 ID(`myid`) 필요.

---

## 2. 카프카 브로커 설치

### 설치 개요
- 카프카 브로커는 메시지의 저장과 전달을 담당하는 핵심 컴포넌트.
- 설치 전 자바와 주키퍼 환경이 구성되어 있어야 함.
- 여러 설치 방법:
  - **리눅스 패키지 설치**: 직접 다운로드 후 압축 해제.
  - **Docker**: 컨테이너 환경에서 간단히 실행.
  - **WSL**: Windows Subsystem for Linux에서 리눅스 환경 구성 후 설치.

---

## 3. 브로커 구성

### 주요 구성 옵션
1. **`broker.id`**  
   - 클러스터 내에서 브로커를 식별하는 고유 ID.
   - 정수 값으로 지정하며, 기본값은 `0`.

2. **`port`**  
   - 카프카 브로커가 사용하는 TCP 포트. 기본값은 `9092`.
   - 포트는 1024 이상의 값으로 설정 권장.

3. **`zookeeper.connect`**  
   - 주키퍼 서버 주소를 설정. 기본값은 `localhost:2181`.
   - 형식: `[호스트명:포트/경로]`로 지정하여 충돌 방지 가능.

4. **`log.dirs`**  
   - 메시지가 저장되는 디스크 경로.
   - 여러 경로를 쉼표로 구분하여 지정 가능.

5. **`auto.create.topics.enable`**  
   - 브로커가 자동으로 토픽을 생성할지 여부. 기본값은 `true`.
   - 수동으로 토픽을 관리하려면 `false`로 설정.

---

## 4. 토픽과 파티션 구성

### 토픽 기본 개념
- **토픽(Topic)**: 메시지를 분류하는 단위.
- **파티션(Partition)**: 토픽의 하위 단위로, 데이터를 병렬로 처리하거나 확장성 향상에 사용.

### 주요 토픽 설정
1. **`num.partitions`**  
   - 토픽 생성 시 파티션 수를 지정. 기본값은 `1`.
   - 파티션은 클러스터 확장성을 결정하는 중요한 요소이며, 브로커 수와 같거나 배수로 설정 권장.

2. **`log.retention.ms`**  
   - 메시지 보존 기간을 밀리초 단위로 설정. 기본값은 7일(168시간).

3. **`log.retention.bytes`**  
   - 저장된 메시지의 총 크기를 기준으로 보존 정책을 설정.

4. **`log.segment.bytes`**  
   - 로그 세그먼트를 닫고 새로 생성하는 기준 크기. 기본값은 1GB.
   - 세그먼트가 닫혀야 보존 기간이나 크기 기준에 따라 메시지가 삭제될 수 있음.

5. **`message.max.bytes`**  
   - 메시지의 최대 크기를 설정. 기본값은 1MB.

---

## 5. 카프카 클러스터 구성

### 클러스터 설계
- **브로커**: 카프카 클러스터는 여러 브로커로 구성.
- **복제본(Replica)**:
  - 데이터를 복제하여 장애 발생 시 데이터 손실 방지.
  - 동일 파티션의 복제본은 서로 다른 브로커에 저장.
- **랙 인식 구성**:
  - 각 브로커의 `broker.rack` 설정으로 동일 랙에 복제본 배치 방지.

### 클러스터 관리 시 고려 사항
1. **브로커 수**:
   - 총 데이터 저장 크기와 처리량 요구사항에 따라 결정.
2. **파티션 수**:
   - 처리량과 컨슈머 수에 따라 적절히 분산되도록 설정.
3. **zookeeper.connect**:
   - 클러스터 내 모든 브로커가 동일한 주키퍼 설정 공유.

---

## 6. 하드웨어 및 성능 최적화

### 디스크
- **SSD 사용 권장**:
  - 빠른 디스크 쓰기/읽기 성능으로 프로듀서 및 컨슈머 대기 시간 최소화.
- **로그 세그먼트 크기 조정**:
  - 저장률이 낮은 경우, 세그먼트 크기를 줄여 효율 개선 가능.

### 메모리
- 페이지 캐시를 활용해 컨슈머 성능 최적화.
- 힙 메모리 사용량은 상대적으로 적지만, 여유 메모리는 성능 향상에 기여.

### 네트워크
- TCP 송수신 버퍼 크기 및 동시 연결 수를 적절히 조정:
  - 기본 메모리량(`net.core.wmem_default`, `net.core.rmem_default`) 및 최대 메모리량(`net.core.wmem_max`, `net.core.rmem_max`) 설정.
- TCP 윈도우 크기 조정을 활성화(`net.ipv4.tcp_window_scaling=1`).

### CPU
- 압축과 체크섬 작업에 사용되며, 성능 최적화를 위해 적절한 CPU 할당 필요.

---

## 7. 운영체제 설정

### 가상 메모리 최적화
1. **스와핑 최소화**:
   - `vm.swappiness=1`로 설정하여 스왑 사용 최소화.
2. **더티 페이지 설정**:
   - `vm.dirty_background_ratio=5` 및 `vm.dirty_ratio=60~80`로 조정.
   - 더티 페이지 수를 모니터링하여 성능 영향 최소화.

### 파일 시스템
- `noatime` 마운트 옵션으로 불필요한 디스크 I/O 제거.
- 안정성을 위해 **XFS 파일 시스템** 추천.

---

## 8. 클라우드 환경에서 카프카 사용

### AWS 인스턴스 추천
1. **m4 인스턴스**:
   - 긴 메시지 보존 기간이 필요한 경우 적합.
2. **r3 인스턴스**:
   - 높은 디스크 처리량 요구 사항에 적합.

---

## 9. 주키퍼와 KRaft 모드

### 주키퍼 역할
- 클러스터 메타데이터 관리 및 장애 복구.
- 최신 카프카는 **KRaft 모드**를 도입하여 주키퍼 없이 독립 실행 가능.

### 주키퍼 구성 팁
- `chroot` 설정으로 클러스터 간 충돌 방지.
- 앙상블 크기를 적정 수준(홀수 개)으로 유지해 성능 안정성 확보.

---

## 10. 요약 및 추가 팁

- 초기 파티션 수와 복제본 설정은 클러스터 설계의 핵심.
- 운영체제와 하드웨어 조정을 통해 카프카의 성능을 극대화.
- 최신 버전 카프카에서는 KRaft 모드를 적극 활용해 주키퍼 의존성 감소 가능.
