# 카프카 컨슈머

## 4.1 카프카 컨슈머: 개념  
### 4.1.1 컨슈머와 컨슈머 그룹  
1. 컨슈머 객체 생성
2. 해당 토픽을 구독
3. 메시지를 받아 검사
4. 결과를 작성
- 만약 이런 일련의 과정보다 메시지가 쌓이는 속도가 더 빠르면? 
> 메시지가 브로커에 계속 쌓이는 현상을 해결하는 방법 -> 컨슈머 작업을 확장

여러개의 프로듀서가 동일한 토픽에 메시지를 쓰듯이, 여러개의 컨슈머가 같은 토픽으로부터 데이터를 분할해서 읽일 수 있다.

### 4.1.2 컨슈머 그룹과 파티션 리벨런스 

컨슈머 재할당 작업 = 리벨런싱    
- 컨슈머 그룹이 읽고 있는 토픽이 변경되었을 때
- 컨슈머가 종료되거나 크래시 난 경우
- 새로운 컨슈머를 컨슈머 그룹에 추가하면
>이전에 다른 컨슈머가 읽고 있던 파티션으로부터 메시지를 읽기 시작

파티션 할당 전략
1. 조급한 리벨런스   
- 모든 컨슈머가 읽기 작업 중단 및 소유권 포기
- 컨슈머 그룹에 다시 참여하여 완전히 새로운 파티션 할당   

2. 협력적 리벨런스(점진적 리벨런스)  
- 우선 컨슈머 그룹 리더가 다른 컨슈머들에게 각자에게 할당된 파티션 중 일부가 재할당될 것을 통보
- 컨슈머들은 해당 파티션의 읽기를 멈추고 소유권 포기
- 컨슈머 그룹 리더가 새로운 파티션 할당
- 전체 작업이 중단되는 사태는 방지
- 컨슈머 수가 많은 경우
- 컨슈머는 브로커에 하트비트를 전송함으로써 할당된 파티션 소유권 유지
- 일정 시간 이상 하트비트를 전송하지 않으면 -> 세션 타임아웃 발생, 그룹 코디네이터가 리벨런스 실행

### 4.1.3 정적 그룹 멤버십
- 컨슈머가 갖는 컨슈머 그룹의 멤버로서의 자격(멤버십)은 일시적
- 컨슈머에 고유한 group.instance.id 값을 잡지 않는 이상 유효
- 정적 멤버 컨슈머가 꺼질 경우, 자동으로 그룹을 떠나지 않음
- 컨슈머가 다시 조인하면 멤버십이 그대로 유지 -> 리벨런스 불필요, 기존 파티션 재할당
- 코디네이터는 각 멤버에 할당한 파티션을 캐시해 둠
- 애플리케이션이 각 컨슈머에 할당된 파티션의 내용물을 사용해 로컬 상태나 캐시 유지해야할 때 편리

## 4.2 카프카 컨슈머 생성하기 
- KafkaConsumer 는 KafkaProducer와 비슷하지만, 추가적으로 group.id 속성이 있음

## 4.3 토픽 구독하기
- 컨슈머 생성하고 다음 할 일 1개 이상의 토픽 구독
> consumer.subscribe(Pattern.compile("test.*"))

## 4.5 컨슈머 설정하기
1. fetch.min.bytes
   - 데이터를 받아올 때 최소량 지정 (기본값 1바이트)
   - fetch.min.bytes 보다 작을 경우, 브로커는 충분한 메시지를 보낼 수 있을 때까지 기다린 뒤 컨슈머에게 레코드를 전달
   - 부하를 줄여주는 효과
2. fetch.max.wait.ms
   - 충분한 데이터가 모일때까지 기다리도록 할 수 있다.
   - 얼마나 오래 기다릴지 결정
3. fetch.max.bytes
   - 컨슈머가 서버로부터 받은 데이터를 저장하기 위해 사용하는 메모리의 양을 제한할 때 사용

## 4.6 오프셋과 커밋
- 아직 읽지 않은 레코드 리턴
- 그룹 내의 컨슈머가 어떤 레코드를 읽었는지 판단 가능
- **컨슈머는 어떻게 오프셋을 커밋하는가?**
  - 카프카에 특수 토픽인 __consumer_offsets 토픽에 각 파티션별로 커밋된 오프셋을 업데이트하도록 메시지를 보냄
  
### 4.6.1 자동 커밋
- 컨슈머가 대신하도록 하는 것
- 5초간격으로 커밋
- 중복을 완전히 없애는 것은 불가능

### 4.6.2 현재 오프셋 커밋하기  
- 메시지 유실의 가능성을 제거
- 리밸런스 발생시 중복되는 메시지의 수를 줄이기 위해서
- enable.auto.commit=false로 명시적 설정
- commitSync()는 poll() 에 의해 리턴된 마지막 오프셋을 커밋한다는 점 주의

### 4.6.3 비동기적 커밋
- 요청만 보내고 처리
- 재시도하지 않음

### 4.6.4 동기적 커밋과 비동기적 커밋을 함께 사용하기
- 컨슈머를 닫기 전 혹은 리밸런스 전 마지막 커밋이라면, 성공 여부를 추가로 확인할 필요가 있을 경우

### 4.6.5 특정 오프셋 커밋하기

## 4.7 리밸런스 리스너 
