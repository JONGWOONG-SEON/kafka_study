

# Race Condition - Kafka Producer와 Consumer 관점

## 1. Race Condition 개념
`Race Condition`은 **여러 스레드가 동시에 공유 자원에 접근할 때 발생하는 문제**입니다.  
- 작업의 실행 순서가 예측할 수 없게 되며, 이로 인해 데이터 불일치, 손실, 충돌 등의 문제가 발생할 수 있습니다.
- Kafka의 `Producer`와 `Consumer`는 각각의 동작 방식과 설계에 따라 `Race Condition` 문제를 다르게 처리합니다.

---

## 2. Kafka Producer에서의 Race Condition

Kafka `Producer`는 **thread-safe**하지만, 다음과 같은 상황에서 `Race Condition`이 발생할 수 있습니다:

### 발생 가능한 상황
1. **메시지 순서 관리**:
   - 여러 스레드가 같은 `Producer` 인스턴스를 공유하며 `send()`를 호출할 때, 메시지 순서가 섞일 수 있습니다.
   - 특히, 동일 파티션에 전송해야 하는 메시지의 순서가 중요한 경우 문제가 발생할 수 있습니다.

2. **Partition Key 충돌**:
   - 동일한 파티션 키를 사용하는 여러 메시지가 동시에 전송되면, 내부적으로 순서가 엉킬 가능성이 있습니다.
   - 이는 `linger.ms`(배치 전송 대기 시간) 설정에 따라 더욱 심각해질 수 있습니다.

### 해결 방안
- **Key 설정**: 메시지 전송 시 `key`를 설정하여 특정 파티션으로 메시지가 고정되도록 보장합니다.
- **전용 스레드 사용**: 순서가 중요한 작업은 별도의 스레드에서 관리합니다.
- **Retries 관리**: `retries` 설정을 통해 네트워크 오류 시 재전송 로직을 안전하게 관리합니다.

---

## 3. Kafka Consumer에서의 Race Condition

Kafka `Consumer`는 **thread-safe하지 않으므로 Race Condition**이 발생하기 쉽습니다.

### 발생 가능한 상황
1. **데이터 읽기와 오프셋 커밋 간의 충돌**:
   - 데이터 처리 중 다른 스레드에서 오프셋을 커밋하면, 처리되지 않은 메시지가 스킵되거나 중복 처리될 수 있습니다.
   - 이는 `manual commit`(수동 커밋) 방식에서 특히 빈번합니다.

2. **Rebalance 중 상태 손실**:
   - Consumer Group에서 리밸런스가 발생하면, 처리 중인 메시지가 다른 Consumer로 이동하며 상태가 손실될 수 있습니다.

3. **멀티스레드 데이터 처리**:
   - 여러 스레드가 동일한 `KafkaConsumer` 인스턴스에서 데이터를 가져오거나 오프셋을 커밋하려 하면 충돌이 발생합니다.

### 해결 방안
- **스레드 안전한 데이터 처리**:
  - `KafkaConsumer`는 단일 스레드에서만 사용하고, 데이터를 가져온 후 처리 로직을 스레드 풀로 넘깁니다.
- **Auto Commit 비활성화**:
  - `enable.auto.commit=false`로 설정하고, 데이터 처리가 완료된 후 명시적으로 `commitSync()` 또는 `commitAsync()`를 호출합니다.
- **Rebalance Listener 활용**:
  - 리밸런스 시 상태를 저장하고 복원하는 로직을 추가하여 데이터 손실을 방지합니다.

---

## 4. Race Condition 예방 요약

| 관점             | 발생 가능 상황                                         | 해결 방안                                          |
|------------------|-------------------------------------------------------|---------------------------------------------------|
| **Kafka Producer** | 메시지 순서 엉킴, 파티션 키 충돌                        | 키 설정, 전용 스레드 사용, 배치 전송 설정 관리       |
| **Kafka Consumer** | 오프셋 커밋 충돌, 리밸런스 중 상태 손실, 멀티스레드 처리 | 단일 스레드 사용, Auto Commit 비활성화, 리스너 추가 |

---

## 추가 고려 사항
- **모니터링**:
  - Kafka의 메시지 순서 문제나 데이터 손실을 방지하려면, 로그와 메트릭을 활용한 모니터링이 필수적입니다.
- **테스트 환경 구성**:
  - `Race Condition` 문제를 발견하려면, 실제 환경과 유사한 테스트 환경에서 멀티스레드 테스트를 수행해야 합니다.

Kafka의 `Producer`와 `Consumer`가 특정 작업을 안전하게 수행하도록 설계하려면, 위의 예방 방안을 기반으로 구현하면 됩니다.
