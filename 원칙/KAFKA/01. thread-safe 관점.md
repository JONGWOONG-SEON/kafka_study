

# Thread-safe - Kafka Producer와 Consumer 관점

## 1. Kafka Producer의 Thread-safe 관점
Kafka의 `Producer`는 기본적으로 **thread-safe**합니다.  
이는 여러 스레드가 동시에 하나의 `KafkaProducer` 인스턴스를 공유하며 데이터를 전송할 수 있음을 의미합니다.

### 설계 방식
- **내부 리소스 공유**
  - `KafkaProducer`는 내부적으로 `synchronized` 블록이나 락을 사용하여 스레드 간 충돌을 방지합니다.
  - TCP 연결 및 메타데이터 캐시와 같은 공유 리소스를 안전하게 관리합니다.
- **비동기 전송**
  - `send` 메서드는 비동기로 동작하며, 여러 스레드가 동시에 호출해도 안전합니다.
  - 전송 요청은 내부 큐에 저장된 후 별도의 I/O 스레드가 처리합니다.

### 주의점
- **인스턴스 수 관리**
  - `KafkaProducer`는 비용이 높은 리소스(TCP 연결 등)를 사용하므로, 여러 스레드가 하나의 인스턴스를 공유하는 것이 성능적으로 유리합니다.
  - 필요 이상으로 많은 `Producer` 인스턴스를 생성하지 않도록 주의해야 합니다.
- **종료 시 처리**
  - `close()` 메서드를 호출하면 내부 리소스가 해제되므로, 다른 스레드에서 사용 중인 경우 충돌이 발생할 수 있습니다. 따라서 `close()`는 모든 작업이 완료된 후 호출해야 합니다.

---

## 2. Kafka Consumer의 Thread-safe 관점
Kafka의 `Consumer`는 **thread-safe하지 않음**.  
이는 `KafkaConsumer` 인스턴스가 **단일 스레드에서만 사용**되도록 설계되었음을 의미합니다.

### 설계 방식
- **비동기 처리 없음**
  - `poll` 메서드는 내부적으로 상태를 관리하며, 여러 스레드가 동시에 접근하면 상태 불일치 문제가 발생할 수 있습니다.
  - `KafkaConsumer`는 데이터를 가져오고, 오프셋을 관리하는 등 상태 의존적인 작업을 수행하므로 thread-safe하지 않습니다.

### 권장 접근 방식
1. **각 스레드별로 `KafkaConsumer` 인스턴스를 생성**
   - 각 스레드가 독립적으로 `KafkaConsumer`를 생성하여 작업을 수행하도록 합니다.
   - 이는 Kafka의 "consumer group" 구조와 잘 맞아떨어집니다. 각 스레드는 개별 파티션을 처리하므로 병렬 처리가 자연스럽게 이루어집니다.
2. **멀티스레드로 데이터 처리**
   - `poll`로 가져온 데이터는 스레드 풀이나 작업 큐에 전달하여 멀티스레드로 처리합니다.
   - 이렇게 하면 `KafkaConsumer`의 thread-safety 문제를 피하면서, 데이터 처리를 병렬화할 수 있습니다.

### 주의점
- **Offset 관리**
  - 오프셋 관리(`commitSync`나 `commitAsync`)는 주의가 필요합니다. 잘못된 설계는 데이터 손실이나 중복 처리를 초래할 수 있습니다.
- **Rebalance 문제**
  - Consumer Group에서 리밸런스가 발생하면 특정 스레드가 맡고 있던 파티션이 다른 스레드로 이동할 수 있으므로, 이를 고려한 설계가 필요합니다.

---

## Thread-safe 설계 요약

| 특성             | Kafka Producer                              | Kafka Consumer                           |
|------------------|---------------------------------------------|------------------------------------------|
| **Thread-safe**   | Yes (여러 스레드에서 안전하게 사용 가능)      | No (단일 스레드에서만 사용 권장)          |
| **사용 방식**     | 하나의 인스턴스를 여러 스레드가 공유         | 각 스레드별로 별도 인스턴스 생성           |
| **리소스 관리**   | 인스턴스 재사용 권장, 종료 시 `close()` 주의 | 데이터 처리 병렬화는 스레드 풀을 활용      |

---